name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PARSER_IMAGE_NAME: ${{ github.repository }}-parser

jobs:
  # –®–∞–≥ 1: –¢–µ—Å—Ç—ã
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [bot, parser]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test Python modules (bot)
      if: matrix.component == 'bot'
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: Install uv
      if: matrix.component == 'bot'
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Install Python dependencies (bot)
      if: matrix.component == 'bot'
      working-directory: src/bot
      run: uv sync --extra dev

    - name: Run Python tests (bot)
      if: matrix.component == 'bot'
      env:
        TELEGRAM_BOT_TOKEN: "test_token_for_ci"
        TELEGRAM_CHAT_ID: "test_chat_id_for_ci"
        PYTHONPATH: ${{ github.workspace }}/src
      working-directory: src/bot
      run: uv run pytest -v --tb=short

    - name: Set up Go
      if: matrix.component == 'parser'
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install Go dependencies
      if: matrix.component == 'parser'
      working-directory: src/parser
      run: go mod download

    - name: Run Go tests
      if: matrix.component == 'parser'
      working-directory: src/parser
      run: go test -v ./...

    - name: Check syntax (bot)
      if: matrix.component == 'bot'
      env:
        TELEGRAM_BOT_TOKEN: "test_token_for_ci"
        TELEGRAM_CHAT_ID: "test_chat_id_for_ci"
        PYTHONPATH: ${{ github.workspace }}/src
      working-directory: src/bot
      run: |
        uv run python -m py_compile config.py simple_bot.py metrics.py
        echo "‚úÖ Syntax check passed"

  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [bot, parser]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Lint Python modules (bot)
      if: matrix.component == 'bot'
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install uv
      if: matrix.component == 'bot'
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Install Python dependencies (bot)
      if: matrix.component == 'bot'
      working-directory: src/bot
      run: uv sync --extra dev

    - name: Check Python imports (bot)
      if: matrix.component == 'bot'
      env:
        TELEGRAM_BOT_TOKEN: "test_token_for_ci"
        TELEGRAM_CHAT_ID: "test_chat_id_for_ci"
        PYTHONPATH: ${{ github.workspace }}/src
      working-directory: src/bot
      run: uv run python -c "from bot import config; from bot import simple_bot; from bot import metrics" || exit 1

    - name: Set up Go
      if: matrix.component == 'parser'
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Go vet
      if: matrix.component == 'parser'
      working-directory: src/parser
      run: go vet ./...

    - name: Go fmt check
      if: matrix.component == 'parser'
      working-directory: src/parser
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "‚ùå Code is not formatted. Run: gofmt -s -w ."
          gofmt -s -d .
          exit 1
        fi
        echo "‚úÖ Code is properly formatted"

  # –®–∞–≥ 2: –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤)
  build:
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for Bot
      id: meta-bot
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}

    - name: Extract metadata for Parser
      id: meta-parser
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.PARSER_IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}

    - name: Build and push Bot image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./src/bot/Dockerfile
        push: true
        tags: ${{ steps.meta-bot.outputs.tags }}
        labels: ${{ steps.meta-bot.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push Parser image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./src/parser/Dockerfile
        push: true
        tags: ${{ steps.meta-parser.outputs.tags }}
        labels: ${{ steps.meta-parser.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # –®–∞–≥ 3: –î–µ–ø–ª–æ–π (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏ –∏ —Ç–æ–ª—å–∫–æ –¥–ª—è main)
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Copy configuration files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        source: "docker/docker-compose.prod.yml,configs/alloy.config.river"
        target: ${{ secrets.DEPLOY_PATH || '/opt/newsagent' }}
        debug: true
        strip_components: 0

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      env:
        REGISTRY_TOKEN: ${{ secrets.GHCR_TOKEN || secrets.GITHUB_TOKEN }}
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        debug: true
        envs: REGISTRY_TOKEN
        script: |
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
          cd ${{ secrets.DEPLOY_PATH || '/opt/newsagent' }}
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Docker
          if ! command -v docker &> /dev/null; then
            echo "‚ùå Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º docker compose (–Ω–æ–≤—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å) –∏–ª–∏ docker-compose (—Å—Ç–∞—Ä—ã–π)
          if docker compose version &> /dev/null; then
            COMPOSE_CMD="docker compose"
          elif command -v docker-compose &> /dev/null; then
            COMPOSE_CMD="docker-compose"
          else
            echo "‚ùå docker compose –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker Compose."
            exit 1
          fi
          
          echo "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º: $COMPOSE_CMD"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
          if [ ! -f .env ]; then
            echo "‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏."
            echo "   –°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ DEPLOY.md"
            exit 1
          fi
          
          # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry —Å retry
          # REGISTRY_TOKEN –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ envs –∏–∑ GitHub Actions
          # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GHCR_TOKEN (Personal Access Token) –µ—Å–ª–∏ –∑–∞–¥–∞–Ω, –∏–Ω–∞—á–µ GITHUB_TOKEN
          # GITHUB_TOKEN –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ GitHub Actions, –Ω–æ –º–æ–∂–µ—Ç –Ω–µ –∏–º–µ—Ç—å –ø—Ä–∞–≤ 'read:packages'
          echo "üîë –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ö–æ–¥ –≤ ${{ env.REGISTRY }}"
          echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${{ github.actor }}"
          echo "üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å registry —á–µ—Ä–µ–∑ DNS
          echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ ${{ env.REGISTRY }}..."
          if ! nslookup ${{ env.REGISTRY }} >/dev/null 2>&1 && ! getent hosts ${{ env.REGISTRY }} >/dev/null 2>&1; then
            echo "‚ùå –û—à–∏–±–∫–∞ DNS: –Ω–µ —É–¥–∞–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∏–º—è ${{ env.REGISTRY }}"
            echo ""
            echo "üîç –ü—Ä–æ–±–ª–µ–º–∞ —Å DNS/—Å–µ—Ç—å—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
            echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ping 8.8.8.8"
            echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS: nslookup ghcr.io"
            echo "   3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π DNS (–Ω–∞–ø—Ä–∏–º–µ—Ä, 8.8.8.8 –∏–ª–∏ 1.1.1.1)"
            echo "   4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ firewall/proxy –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
            echo ""
            echo "üí° –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:"
            echo "   –î–æ–±–∞–≤—å—Ç–µ –≤ /etc/hosts:"
            echo "   $(dig +short ghcr.io | head -1) ghcr.io"
            echo ""
            exit 1
          fi
          echo "‚úÖ DNS —Ä–∞–∑—Ä–µ—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            LOGIN_OUTPUT=$(echo "$REGISTRY_TOKEN" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin 2>&1)
            LOGIN_EXIT_CODE=$?
            if [ $LOGIN_EXIT_CODE -eq 0 ]; then
              echo "‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ ${{ env.REGISTRY }}"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "‚ö†Ô∏è  –ü–æ–ø—ã—Ç–∫–∞ $RETRY_COUNT/$MAX_RETRIES –Ω–µ —É–¥–∞–ª–∞—Å—å"
              echo "   –û—à–∏–±–∫–∞: $LOGIN_OUTPUT"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏
              if echo "$LOGIN_OUTPUT" | grep -q "lookup.*timeout\|dial tcp.*timeout"; then
                echo "   üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å DNS/—Å–µ—Ç—å—é"
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "   –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 10 —Å–µ–∫ (—É–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º)..."
                  sleep 10
                fi
              elif echo "$LOGIN_OUTPUT" | grep -q "unauthorized\|denied\|authentication"; then
                echo "   üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π"
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "   –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫..."
                  sleep 5
                fi
              else
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "   –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫..."
                  sleep 5
                fi
              fi
              
              if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
                echo ""
                echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ ${{ env.REGISTRY }} –ø–æ—Å–ª–µ $MAX_RETRIES –ø–æ–ø—ã—Ç–æ–∫"
                echo ""
                if echo "$LOGIN_OUTPUT" | grep -q "lookup.*timeout\|dial tcp.*timeout"; then
                  echo "üîç –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ DNS/—Å–µ—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
                  echo ""
                  echo "üí° –†–µ—à–µ–Ω–∏—è:"
                  echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ping 8.8.8.8"
                  echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DNS: nslookup ghcr.io"
                  echo "   3. –ò–∑–º–µ–Ω–∏—Ç–µ DNS —Å–µ—Ä–≤–µ—Ä –≤ /etc/resolv.conf:"
                  echo "      nameserver 8.8.8.8"
                  echo "      nameserver 1.1.1.1"
                  echo "   4. –ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ /etc/hosts:"
                  echo "      $(dig +short ghcr.io 2>/dev/null | head -1 || echo 'IP_ADDRESS') ghcr.io"
                elif echo "$LOGIN_OUTPUT" | grep -q "unauthorized\|denied"; then
                  echo "üîç –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"
                  echo ""
                  echo "üí° –†–µ—à–µ–Ω–∏–µ:"
                  echo "   –°–æ–∑–¥–∞–π—Ç–µ Personal Access Token (classic) —Å –ø—Ä–∞–≤–∞–º–∏ 'read:packages'"
                  echo "   –∏ –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –∫–∞–∫ —Å–µ–∫—Ä–µ—Ç GHCR_TOKEN –≤ GitHub Secrets"
                else
                  echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –æ—à–∏–±–∫–∏"
                fi
                echo ""
                exit 1
              fi
            fi
          done
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          $COMPOSE_CMD -f docker-compose.prod.yml down || true
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑—ã —Å retry (–Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ç—å—é)
          echo "üì• –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
          PULL_RETRIES=3
          PULL_COUNT=0
          while [ $PULL_COUNT -lt $PULL_RETRIES ]; do
            if $COMPOSE_CMD -f docker-compose.prod.yml pull newsagent grafana-alloy; then
              echo "‚úÖ –û–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
              break
            else
              PULL_COUNT=$((PULL_COUNT + 1))
              if [ $PULL_COUNT -lt $PULL_RETRIES ]; then
                echo "‚ö†Ô∏è  –ü–æ–ø—ã—Ç–∫–∞ $PULL_COUNT/$PULL_RETRIES –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 10 —Å–µ–∫..."
                sleep 10
              else
                echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Ä–∞–∑—ã –ø–æ—Å–ª–µ $PULL_RETRIES –ø–æ–ø—ã—Ç–æ–∫"
                echo "   –í–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é/DNS –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
                exit 1
              fi
            fi
          done
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤–∫–ª—é—á–∞—è Alloy)
          $COMPOSE_CMD -f docker-compose.prod.yml up -d
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
          docker image prune -f
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
          $COMPOSE_CMD -f docker-compose.prod.yml ps

    - name: Health check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          cd ${{ secrets.DEPLOY_PATH || '/opt/newsagent' }}
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º docker compose –∫–æ–º–∞–Ω–¥—É
          if docker compose version &> /dev/null; then
            COMPOSE_CMD="docker compose"
          elif command -v docker-compose &> /dev/null; then
            COMPOSE_CMD="docker-compose"
          else
            echo "‚ùå docker compose –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
          $COMPOSE_CMD -f docker-compose.prod.yml ps
          
          # –ñ–¥–µ–º –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è (–º–∞–∫—Å–∏–º—É–º 60 —Å–µ–∫—É–Ω–¥)
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–º–∞–∫—Å–∏–º—É–º 60 —Å–µ–∫—É–Ω–¥)..."
          MAX_WAIT=60
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            if $COMPOSE_CMD -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"
              break
            fi
            echo "   –û–∂–∏–¥–∞–Ω–∏–µ... ($ELAPSED/$MAX_WAIT —Å–µ–∫)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          if ! $COMPOSE_CMD -f docker-compose.prod.yml ps | grep -q "Up"; then
            echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
            echo ""
            echo "üìã –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            $COMPOSE_CMD -f docker-compose.prod.yml ps
            echo ""
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
            $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50 newsagent
            exit 1
          fi
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–∞—É–∑–∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (15 —Å–µ–∫—É–Ω–¥)..."
          sleep 15
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫..."
          if curl -f -s --max-time 10 http://localhost:8000/metrics > /dev/null; then
            echo "‚úÖ Health check passed - –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã"
          else
            echo "‚ùå Health check failed - –º–µ—Ç—Ä–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
            echo ""
            echo "üìã –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            $COMPOSE_CMD -f docker-compose.prod.yml ps
            echo ""
            echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
            $COMPOSE_CMD -f docker-compose.prod.yml logs --tail=50 newsagent
            echo ""
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞:"
            netstat -tlnp 2>/dev/null | grep 8000 || ss -tlnp 2>/dev/null | grep 8000 || echo "–ü–æ—Ä—Ç 8000 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è"
            exit 1
          fi

