# –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏

## 1. –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç—Ä–∏–∫ –±–æ—Ç–∞

### –ß–µ—Ä–µ–∑ curl (–∫–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞)

```bash
# –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏
curl http://localhost:8000/metrics

# –¢–æ–ª—å–∫–æ –º–µ—Ç—Ä–∏–∫–∏ –±–æ—Ç–∞
curl http://localhost:8000/metrics | grep telegram_bot

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞
curl http://localhost:8000/metrics | grep telegram_bot_commands_total
```

### –ß–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä

–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:8000/metrics

## 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Grafana Alloy UI

–ï—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω Grafana Alloy:

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
http://localhost:12345
```

–í UI Alloy –≤—ã —É–≤–∏–¥–∏—Ç–µ:
- –°—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ú–µ—Ç—Ä–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è
- –õ–æ–≥–∏ —Ä–∞–±–æ—Ç—ã

## 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Grafana Cloud

1. –û—Ç–∫—Ä–æ–π—Ç–µ Grafana Cloud
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Explore**
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å—ã:

```promql
# –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥
telegram_bot_commands_total

# –ö–æ–º–∞–Ω–¥—ã –ø–æ —Ç–∏–ø–∞–º
telegram_bot_commands_total{command="start"}
telegram_bot_commands_total{command="help"}

# –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
telegram_bot_uptime_seconds

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
telegram_bot_messages_sent_total

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
telegram_bot_errors_total

# –°–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ (–∫–æ–º–∞–Ω–¥ –≤ –º–∏–Ω—É—Ç—É)
rate(telegram_bot_commands_total[1m])

# –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
rate(telegram_bot_command_duration_seconds_sum[5m]) / rate(telegram_bot_command_duration_seconds_count[5m])
```

## 4. –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

### –°—á–µ—Ç—á–∏–∫–∏ (Counters)

- `telegram_bot_commands_total{command}` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ (–ø–æ —Ç–∏–ø–∞–º)
- `telegram_bot_messages_sent_total` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- `telegram_bot_errors_total{error_type}` - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ (–ø–æ —Ç–∏–ø–∞–º)

### –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã (Histograms)

- `telegram_bot_command_duration_seconds{command}` - –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
  - `_bucket` - buckets –¥–ª—è –∫–≤–∞–Ω—Ç–∏–ª–µ–π
  - `_sum` - —Å—É–º–º–∞ –≤—Ä–µ–º–µ–Ω–∏
  - `_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π

### Gauges

- `telegram_bot_uptime_seconds` - –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

## 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

–ß—Ç–æ–±—ã –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—è–≤–∏–ª–∏—Å—å, –Ω—É–∂–Ω–æ:

1. **–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É** –≤ Telegram:
   - `/start` - —É–≤–µ–ª–∏—á–∏—Ç `telegram_bot_commands_total{command="start"}`
   - `/help` - —É–≤–µ–ª–∏—á–∏—Ç `telegram_bot_commands_total{command="help"}`

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏**:
```bash
curl http://localhost:8000/metrics | grep telegram_bot_commands_total
```

## 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Grafana Alloy

```bash
# –õ–æ–≥–∏ Alloy
docker-compose logs grafana-alloy

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Alloy —Å–∫—Ä–∞–ø–∏—Ç –º–µ—Ç—Ä–∏–∫–∏
docker-compose exec grafana-alloy wget -qO- http://newsagent:8000/metrics | head -5
```

## 7. –ü–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è Grafana

### –î–∞—à–±–æ—Ä–¥ –º–µ—Ç—Ä–∏–∫

```promql
# Uptime –≤ —á–∞—Å–∞—Ö
telegram_bot_uptime_seconds / 3600

# –ö–æ–º–∞–Ω–¥—ã –≤ –º–∏–Ω—É—Ç—É
rate(telegram_bot_commands_total[1m]) * 60

# 95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
histogram_quantile(0.95, rate(telegram_bot_command_duration_seconds_bucket[5m]))

# –°–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É
rate(telegram_bot_messages_sent_total[1m]) * 60

# –û—à–∏–±–æ–∫ –≤ –º–∏–Ω—É—Ç—É
rate(telegram_bot_errors_total[1m]) * 60
```

## 8. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `diagnose_metrics.sh` –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
# –ù–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ - —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp scripts/diagnose_metrics.sh user@server:/opt/newsagent/

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ - –∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
cd /opt/newsagent
chmod +x diagnose_metrics.sh
./diagnose_metrics.sh
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç:
- ‚úÖ –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- ‚úÖ –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- ‚úÖ –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞ 8000
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –∏–∑–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ —Å —Ö–æ—Å—Ç–∞
- ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- ‚úÖ –°–µ—Ç–µ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é docker-compose

### –†—É—á–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

–ï—Å–ª–∏ –º–µ—Ç—Ä–∏–∫–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ –ø–æ—Ä—è–¥–∫—É:

#### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

```bash
cd /opt/newsagent
docker-compose -f docker-compose.prod.yml ps
```

–î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç–∞—Ç—É—Å `Up` –∏ –ø–æ—Ä—Ç `0.0.0.0:8000->8000/tcp`.

#### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

```bash
docker-compose -f docker-compose.prod.yml logs --tail=50 newsagent
```

–ò—â–∏—Ç–µ:
- `üìä Prometheus metrics endpoint –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8000` - –º–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø—É—â–µ–Ω—ã
- –û—à–∏–±–∫–∏ –∑–∞–ø—É—Å–∫–∞
- –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–∑–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

```bash
docker exec newsagent-bot curl -s http://localhost:8000/metrics | head -20
```

–ï—Å–ª–∏ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ö–æ—Å—Ç–∞ - –ø—Ä–æ–±–ª–µ–º–∞ –≤ –ø—Ä–æ–±—Ä–æ—Å–µ –ø–æ—Ä—Ç–∞.

#### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ —Å —Ö–æ—Å—Ç–∞

```bash
curl -v http://localhost:8000/metrics
```

–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–∞ –≤ `docker-compose.prod.yml`:
  ```yaml
  ports:
    - "8000:8000"
  ```
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall:
  ```bash
  sudo ufw status
  sudo ufw allow 8000/tcp
  ```

#### 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
cd /opt/newsagent
cat .env
```

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:
- `TELEGRAM_BOT_TOKEN` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–µ –ø—É—Å—Ç
- `TELEGRAM_CHAT_ID` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–µ –ø—É—Å—Ç
- `METRICS_PORT=8000` (–∏–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —Ç–æ–≥–¥–∞ –±—É–¥–µ—Ç 8000 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

#### 6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

```bash
docker exec newsagent-bot ps aux
```

–î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Ü–µ—Å—Å `python simple_bot.py`.

#### 7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```bash
# –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker exec newsagent-bot netstat -tlnp | grep 8000
# –∏–ª–∏
docker exec newsagent-bot ss -tlnp | grep 8000

# –ù–∞ —Ö–æ—Å—Ç–µ
netstat -tlnp | grep 8000
# –∏–ª–∏
ss -tlnp | grep 8000
```

#### 8. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

```bash
cd /opt/newsagent
docker-compose -f docker-compose.prod.yml restart newsagent
docker-compose -f docker-compose.prod.yml logs -f newsagent
```

### –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

#### –ü—Ä–æ–±–ª–µ–º–∞: "Connection refused" –ø—Ä–∏ curl

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ—Ä—Ç –Ω–µ –ø—Ä–æ–±—Ä–æ—à–µ–Ω –∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `docker-compose.prod.yml` - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `ports: - "8000:8000"`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker logs newsagent-bot`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: `docker-compose -f docker-compose.prod.yml restart newsagent`

#### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ—Ç—Ä–∏–∫–∏ –ø—É—Å—Ç—ã–µ –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–∏—á–∏–Ω–∞:** –ë–æ—Ç –µ—â–µ –Ω–µ –ø–æ–ª—É—á–∏–ª –∫–æ–º–∞–Ω–¥—ã

**–†–µ—à–µ–Ω–∏–µ:**
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É –≤ Telegram: `/start` –∏–ª–∏ `/help`
2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ —Å–Ω–æ–≤–∞: `curl http://localhost:8000/metrics | grep telegram_bot`

#### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ—Ç—Ä–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –Ω–æ –Ω–µ —Å —Ö–æ—Å—Ç–∞

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ–±—Ä–æ—Å–æ–º –ø–æ—Ä—Ç–∞ –∏–ª–∏ firewall

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–∞ –≤ `docker-compose.prod.yml`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall: `sudo ufw status`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ—Ä—Ç —Å–ª—É—à–∞–µ—Ç—Å—è: `netstat -tlnp | grep 8000`

#### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–∞–¥–∞–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞

**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker logs newsagent-bot`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` —Ñ–∞–π–ª
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Grafana Alloy (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

```bash
# –°—Ç–∞—Ç—É—Å Alloy
docker-compose -f docker-compose.prod.yml ps grafana-alloy

# –õ–æ–≥–∏ Alloy
docker-compose -f docker-compose.prod.yml logs --tail=50 grafana-alloy

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Alloy —Å–∫—Ä–∞–ø–∏—Ç –º–µ—Ç—Ä–∏–∫–∏
docker-compose -f docker-compose.prod.yml exec grafana-alloy wget -qO- http://newsagent:8000/metrics | head -5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Alloy
docker-compose -f docker-compose.prod.yml exec grafana-alloy cat /etc/alloy/config.river
```

