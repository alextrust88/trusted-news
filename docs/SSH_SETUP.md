# Настройка SSH ключа для деплоя

## Что такое DEPLOY_SSH_KEY?

Это **приватный SSH ключ**, который GitHub Actions будет использовать для подключения к вашему серверу по SSH.

## Пошаговая инструкция

### 1. Создайте SSH ключ (если еще нет)

```bash
# Создайте новый SSH ключ
ssh-keygen -t ed25519 -C "github-actions-deploy"

# Нажмите Enter для сохранения в стандартное место (~/.ssh/id_ed25519)
# Введите пароль (или оставьте пустым для автоматического деплоя)
```

**Результат:**
- `~/.ssh/id_ed25519` - **приватный ключ** (нужен для GitHub Secrets)
- `~/.ssh/id_ed25519.pub` - **публичный ключ** (нужен для сервера)

### 2. Добавьте публичный ключ на сервер

```bash
# Автоматически (если ssh-copy-id установлен)
ssh-copy-id -i ~/.ssh/id_ed25519.pub user@your-server.com

# Или вручную
cat ~/.ssh/id_ed25519.pub | ssh user@your-server.com "mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"
```

### 3. Проверьте подключение

```bash
# Попробуйте подключиться к серверу
ssh -i ~/.ssh/id_ed25519 user@your-server.com

# Если подключение работает - всё готово!
```

### 4. Добавьте приватный ключ в GitHub Secrets

#### Вариант A: Через веб-интерфейс GitHub

1. Откройте ваш репозиторий на GitHub
2. Перейдите в **Settings** → **Secrets and variables** → **Actions**
3. Нажмите **"New repository secret"**
4. Заполните:
   - **Name:** `DEPLOY_SSH_KEY`
   - **Value:** скопируйте весь приватный ключ (см. ниже)
5. Нажмите **"Add secret"**

#### Вариант B: Скопируйте приватный ключ

```bash
# Покажите приватный ключ
cat ~/.ssh/id_ed25519
```

**Скопируйте ВСЁ содержимое**, включая:
```
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACD...
...много строк...
...
-----END OPENSSH PRIVATE KEY-----
```

**Важно:**
- ✅ Копируйте **приватный** ключ (файл без `.pub`)
- ✅ Включайте строки `-----BEGIN...` и `-----END...`
- ✅ Копируйте все строки без пропусков
- ❌ НЕ копируйте публичный ключ (с `.pub`)

### 5. Проверка

После добавления секрета, при следующем push в `main` workflow попытается подключиться к серверу. Если всё настроено правильно - деплой пройдет успешно.

## Использование существующего ключа

Если у вас уже есть SSH ключ:

```bash
# Проверьте существующие ключи
ls -la ~/.ssh/

# Используйте существующий ключ (например, id_rsa)
cat ~/.ssh/id_rsa  # приватный ключ для GitHub
cat ~/.ssh/id_rsa.pub | ssh user@server "cat >> ~/.ssh/authorized_keys"  # публичный на сервер
```

## Безопасность

- ✅ Приватный ключ хранится в GitHub Secrets (зашифрован)
- ✅ Используйте отдельный ключ для деплоя (не ваш основной)
- ✅ Можно добавить пароль к ключу (но тогда нужна настройка ssh-agent)
- ✅ Регулярно ротируйте ключи

## Troubleshooting

### Ошибка: "unable to authenticate, attempted methods [none publickey]"

Эта ошибка означает, что SSH не может аутентифицироваться. Проверьте:

1. **Формат ключа в GitHub Secrets:**
   - Убедитесь что скопирован **приватный** ключ (не публичный)
   - Ключ должен начинаться с `-----BEGIN OPENSSH PRIVATE KEY-----` или `-----BEGIN RSA PRIVATE KEY-----`
   - Все строки должны быть скопированы, включая BEGIN и END

2. **Проверьте что публичный ключ добавлен на сервер:**
```bash
# На сервере проверьте
cat ~/.ssh/authorized_keys
# Должен быть ваш публичный ключ (начинается с ssh-ed25519 или ssh-rsa)
```

3. **Проверьте права доступа на сервере:**
```bash
# На сервере выполните
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
chown $USER:$USER ~/.ssh
chown $USER:$USER ~/.ssh/authorized_keys
```

4. **Проверьте формат ключа:**
   - Если ключ в старом формате (RSA), конвертируйте в OpenSSH:
```bash
ssh-keygen -p -m PEM -f ~/.ssh/id_rsa  # конвертация в PEM формат
```

5. **Проверьте подключение локально:**
```bash
# Попробуйте подключиться с тем же ключом
ssh -i ~/.ssh/id_ed25519 -v user@server
# Флаг -v покажет детали подключения
```

### Ошибка: "Host key verification failed"

Добавьте сервер в known_hosts или используйте опцию `StrictHostKeyChecking=no` в SSH команде (менее безопасно).

### Проверка ключа в GitHub Secrets

Убедитесь что ключ в правильном формате:
- ✅ Должен начинаться с `-----BEGIN`
- ✅ Должен заканчиваться `-----END`
- ✅ Между ними много строк с закодированным содержимым
- ❌ НЕ должен быть публичный ключ (начинается с `ssh-ed25519` или `ssh-rsa`)

